on:
  workflow_dispatch:
  push:
    branches:
      - riscv-jit-rv64

jobs:
  cross-build:
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/dotnet-buildtools/prereqs:ubuntu-22.04-cross-riscv64
      env:
        ROOTFS_DIR: /crossrootfs/riscv64
        QEMU_LD_PREFIX: /crossrootfs/riscv64
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Cross Rebuild
        continue-on-error: true
        run: ./build.sh mono+libs+host+clr.hosts -c Release --cross --arch riscv64 --ci --rebuild
      - name: Cross Build
        if: failure()
      # ./build.sh mono+libs+host+clr.hosts -c Debug --cross --arch riscv64 --ninja /p:KeepNativeSymbols=true --build
        run: ./build.sh mono+libs+host+clr.hosts -c Release --cross --arch riscv64 --ci
      # cache
      - name: Cache
        uses: actions/cache@v2
        with:
          path: |
            .dotnet/
            artifacts/
        key: ${{ runner.os }}-dotnet-cross-build
      - name: Build Tests programs
        run: ./build.sh -mono -debug riscv64 -tree:JIT/ --ci
        working-directory: ./src/tests
      # upload entire project
      - name: Upload Artifacts
        uses: actions/upload-artifact@v2
        with:
          name: jit-riscv64
          path: ./
  
  test:
    continue-on-error: true
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/dotnet-buildtools/prereqs:ubuntu-22.04-cross-riscv64
      env:
        ROOTFS_DIR: /crossrootfs/riscv64
        QEMU_LD_PREFIX: /crossrootfs/riscv64
    needs: cross-build
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v2
        with:
          name: jit-riscv64
      - name: Cache
        uses: actions/cache@v2
        with:
          path: |
            artifacts/tests/coreclr
        key: ${{ runner.os }}-dotnet-test
      - name: Run tests
        run: bash -c ./run.sh Release
        working-directory: ./src/tests
      
